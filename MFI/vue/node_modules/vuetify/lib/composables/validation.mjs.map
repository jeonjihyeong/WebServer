{"version":3,"file":"validation.mjs","names":["useForm","useProxiedModel","computed","onBeforeMount","onBeforeUnmount","onMounted","ref","unref","watch","getCurrentInstanceName","getUid","propsFactory","wrapInArray","makeValidationProps","disabled","Boolean","error","errorMessages","type","Array","String","default","maxErrors","Number","name","readonly","rules","modelValue","validationValue","useValidation","props","id","model","validationModel","value","form","internalErrorMessages","isPristine","isDirty","length","isDisabled","isReadonly","isValid","isValidating","validationClasses","uid","register","validate","reset","resetValidation","unregister","update","results","rule","handler","result","console","warn","push"],"sources":["../../src/composables/validation.ts"],"sourcesContent":["// Composables\nimport { useForm } from '@/composables/form'\nimport { useProxiedModel } from '@/composables/proxiedModel'\n\n// Utilities\nimport { computed, onBeforeMount, onBeforeUnmount, onMounted, ref, unref, watch } from 'vue'\nimport { getCurrentInstanceName, getUid, propsFactory, wrapInArray } from '@/util'\n\n// Types\nimport type { PropType } from 'vue'\nimport type { MaybeRef } from '@/util'\n\nexport type ValidationResult = string | boolean\nexport type ValidationRule =\n  | ValidationResult\n  | PromiseLike<ValidationResult>\n  | ((value: any) => ValidationResult)\n  | ((value: any) => PromiseLike<ValidationResult>)\n\nexport interface ValidationProps {\n  disabled: boolean\n  error: boolean\n  errorMessages: string | string[]\n  maxErrors: string | number\n  name: string | undefined\n  readonly: boolean\n  rules: ValidationRule[]\n  modelValue: any\n  'onUpdate:modelValue': ((val: any) => void) | undefined\n  validationValue: any\n}\n\nexport const makeValidationProps = propsFactory({\n  disabled: Boolean,\n  error: Boolean,\n  errorMessages: {\n    type: [Array, String] as PropType<string | string[]>,\n    default: () => ([]),\n  },\n  maxErrors: {\n    type: [Number, String],\n    default: 1,\n  },\n  name: String,\n  readonly: Boolean,\n  rules: {\n    type: Array as PropType<ValidationRule[]>,\n    default: () => ([]),\n  },\n  modelValue: null,\n  validationValue: null,\n})\n\nexport function useValidation (\n  props: ValidationProps,\n  name = getCurrentInstanceName(),\n  id: MaybeRef<string | number> = getUid(),\n) {\n  const model = useProxiedModel(props, 'modelValue')\n  const validationModel = computed(() => props.validationValue ?? model.value)\n  const form = useForm()\n  const internalErrorMessages = ref<string[]>([])\n  const isPristine = ref(true)\n  const isDirty = computed(() => !!(\n    wrapInArray(model.value === '' ? null : model.value).length ||\n    wrapInArray(validationModel.value === '' ? null : validationModel.value).length\n  ))\n  const isDisabled = computed(() => !!(props.disabled || form?.isDisabled.value))\n  const isReadonly = computed(() => !!(props.readonly || form?.isReadonly.value))\n  const errorMessages = computed(() => {\n    return props.errorMessages.length\n      ? wrapInArray(props.errorMessages)\n      : internalErrorMessages.value\n  })\n  const isValid = computed(() => {\n    if (props.error || errorMessages.value.length) return false\n    if (!props.rules.length) return true\n\n    return isPristine.value ? null : true\n  })\n  const isValidating = ref(false)\n  const validationClasses = computed(() => {\n    return {\n      [`${name}--error`]: isValid.value === false,\n      [`${name}--dirty`]: isDirty.value,\n      [`${name}--disabled`]: isDisabled.value,\n      [`${name}--readonly`]: isReadonly.value,\n    }\n  })\n\n  const uid = computed(() => props.name ?? unref(id))\n\n  onBeforeMount(() => {\n    form?.register({\n      id: uid.value,\n      validate,\n      reset,\n      resetValidation,\n    })\n  })\n\n  onBeforeUnmount(() => {\n    form?.unregister(uid.value)\n  })\n\n  // Set initial valid state, for inputs that might not have rules\n  onMounted(() => form?.update(uid.value, isValid.value, errorMessages.value))\n\n  watch(validationModel, () => {\n    if (validationModel.value != null) validate()\n  })\n\n  watch(isValid, () => {\n    form?.update(uid.value, isValid.value, errorMessages.value)\n  })\n\n  function reset () {\n    resetValidation()\n    model.value = null\n  }\n\n  function resetValidation () {\n    isPristine.value = true\n    internalErrorMessages.value = []\n  }\n\n  async function validate () {\n    const results = []\n\n    isValidating.value = true\n\n    for (const rule of props.rules) {\n      if (results.length >= (props.maxErrors || 1)) {\n        break\n      }\n\n      const handler = typeof rule === 'function' ? rule : () => rule\n      const result = await handler(validationModel.value)\n\n      if (result === true) continue\n\n      if (typeof result !== 'string') {\n        // eslint-disable-next-line no-console\n        console.warn(`${result} is not a valid value. Rule functions must return boolean true or a string.`)\n\n        continue\n      }\n\n      results.push(result)\n    }\n\n    internalErrorMessages.value = results\n    isValidating.value = false\n    isPristine.value = false\n\n    return internalErrorMessages.value\n  }\n\n  return {\n    errorMessages,\n    isDirty,\n    isDisabled,\n    isReadonly,\n    isPristine,\n    isValid,\n    isValidating,\n    reset,\n    resetValidation,\n    validate,\n    validationClasses,\n  }\n}\n"],"mappings":"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"}