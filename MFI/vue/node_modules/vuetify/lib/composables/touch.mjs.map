{"version":3,"file":"touch.mjs","names":["CircularBuffer","HORIZON","HISTORY","kineticEnergyToVelocity","work","sqrt2","Math","sqrt","abs","calculateImpulseVelocity","samples","length","t","d","i","vprev","vcurr","useVelocity","touches","addMovement","e","Array","from","changedTouches","forEach","touch","identifier","push","timeStamp","endTouch","getVelocity","id","values","reverse","Error","newest","x","y","val","clientX","clientY","direction","absX","absY","oops"],"sources":["../../src/composables/touch.ts"],"sourcesContent":["import { CircularBuffer } from '@/util'\n\nconst HORIZON = 100 // ms\nconst HISTORY = 20 // number of samples to keep\n\nexport interface Sample {\n  t: number\n  d: number\n}\n\n/** @see https://android.googlesource.com/platform/frameworks/native/+/master/libs/input/VelocityTracker.cpp */\nfunction kineticEnergyToVelocity (work: number) {\n  const sqrt2 = 1.41421356237\n  return (work < 0 ? -1.0 : 1.0) * Math.sqrt(Math.abs(work)) * sqrt2\n}\n\n/**\n * Returns pointer velocity in px/s\n */\nexport function calculateImpulseVelocity (samples: Sample[]) {\n  // The input should be in reversed time order (most recent sample at index i=0)\n  if (samples.length < 2) {\n    // if 0 or 1 points, velocity is zero\n    return 0\n  }\n  // if (samples[1].t > samples[0].t) {\n  //   // Algorithm will still work, but not perfectly\n  //   consoleWarn('Samples provided to calculateImpulseVelocity in the wrong order')\n  // }\n  if (samples.length === 2) {\n    // if 2 points, basic linear calculation\n    if (samples[1].t === samples[0].t) {\n      // consoleWarn(`Events have identical time stamps t=${samples[0].t}, setting velocity = 0`)\n      return 0\n    }\n    return (samples[1].d - samples[0].d) / (samples[1].t - samples[0].t)\n  }\n  // Guaranteed to have at least 3 points here\n  // start with the oldest sample and go forward in time\n  let work = 0\n  for (let i = samples.length - 1; i > 0; i--) {\n    if (samples[i].t === samples[i - 1].t) {\n      // consoleWarn(`Events have identical time stamps t=${samples[i].t}, skipping sample`)\n      continue\n    }\n    const vprev = kineticEnergyToVelocity(work) // v[i-1]\n    const vcurr = (samples[i].d - samples[i - 1].d) / (samples[i].t - samples[i - 1].t) // v[i]\n    work += (vcurr - vprev) * Math.abs(vcurr)\n    if (i === samples.length - 1) {\n      work *= 0.5\n    }\n  }\n  return kineticEnergyToVelocity(work) * 1000\n}\n\nexport function useVelocity () {\n  const touches: Record<number, CircularBuffer<[number, Touch]> | undefined> = {}\n\n  function addMovement (e: TouchEvent) {\n    Array.from(e.changedTouches).forEach(touch => {\n      const samples = touches[touch.identifier] ?? (touches[touch.identifier] = new CircularBuffer(HISTORY))\n      samples.push([e.timeStamp, touch])\n    })\n  }\n\n  function endTouch (e: TouchEvent) {\n    Array.from(e.changedTouches).forEach(touch => {\n      delete touches[touch.identifier]\n    })\n  }\n\n  function getVelocity (id: number) {\n    const samples = touches[id]?.values().reverse()\n\n    if (!samples) {\n      throw new Error(`No samples for touch id ${id}`)\n    }\n\n    const newest = samples[0]\n    const x: Sample[] = []\n    const y: Sample[] = []\n    for (const val of samples) {\n      if (newest[0] - val[0] > HORIZON) break\n\n      x.push({ t: val[0], d: val[1].clientX })\n      y.push({ t: val[0], d: val[1].clientY })\n    }\n\n    return {\n      x: calculateImpulseVelocity(x),\n      y: calculateImpulseVelocity(y),\n      get direction () {\n        const { x, y } = this\n        const [absX, absY] = [Math.abs(x), Math.abs(y)]\n\n        return absX > absY && x >= 0 ? 'right'\n          : absX > absY && x <= 0 ? 'left'\n          : absY > absX && y >= 0 ? 'down'\n          : absY > absX && y <= 0 ? 'up'\n          : oops()\n      },\n    }\n  }\n\n  return { addMovement, endTouch, getVelocity }\n}\n\nfunction oops (): never {\n  throw new Error()\n}\n"],"mappings":"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"}